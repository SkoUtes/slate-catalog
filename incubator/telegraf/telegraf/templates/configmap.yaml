# Handles configuration of the Telegraf monitoring service. 

apiVersion: v1
kind: ConfigMap
metadata:
  name: telegraf-{{ .Values.Instance }}-configuration
  labels:
    app: {{ template "telegraf.name" . }}
    chart: {{ template "telegraf.chart" . }}
    release: {{ .Release.Name }}
    instance: {{ .Values.Instance | quote }}

# store Telegraf configuration file
data:
  "telegraf.conf": |-
    [global_tags]

    # Configuration for telegraf agent
    [agent]
      interval = {{ .Values.interval | quote }}
      round_interval = true
      metric_batch_size = 1000
      metric_buffer_limit = 50000
      collection_jitter = "0s"
      flush_interval = "300s"
      flush_jitter = "0s"
      precision = ""
      hostname = ""
      omit_hostname = false

    # Send telegraf metrics to stdout and file if enabled
    {{ if eq .Values.writeToStdout true }}
    [[outputs.file]]
      files = ["stdout", "/tmp/metrics.out"]
      data_format = "influx"
    {{ end }}


    # InfluxDB configuration
    {{ if eq .Values.influxOutput.enabled true }}
    [[outputs.influxdb]]
      urls = [{{ .Values.influxOutput.endpoint | quote }}]
      database = {{ .Values.influxOutput.database | quote }}
    {{ end }}


    # GlobalNOC database configuration
    {{ if eq .Values.grnocOutput.enabled true }}
    [[outputs.tsds]]

      # TSDS Measurement Type
      measurement = "interface"

      # TSDS Credentials
      hostname = {{ .Values.grnocOutput.hostname | quote }}
      username = {{ .Values.grnocOutput.username | quote }}
      password = {{ .Values.grnocOutput.password | quote }}

      # Output Processing Interval (This should be greater than the JTI "sample_frequency")
      interval = 60

      # Sensors that are metadata fields
      metadata = ["node", "intf", "description"]

      # Sensors that should have their values tracked and then computed as a rate
      rates = [
        "input",
        "output",
        "inUcast",
        "outUcast",
        "inerror",
        "outerror",
        "indiscard",
        "outdiscard",
      ]

      # An array of strings containing TSDS metadata/value aliases and their corresponding JTI resource path (space-delimited)
        sensors = [
          "intf ifName",
          "node agent_host",
          "description ifDescr",
          "input ifInOctets",
          "output ifOutOctets",
          "inerror ifInErrors",
          "outerror ifOutErrors",
          "inUcast ifInUcastPkts",
          "outUcast ifOutUcastPkts",
          "indiscard ifInDiscards",
          "outdiscard ifOutDiscards",
          "status ifOperStatus",
        ]

    {{ end }}


    # Loop through host groups to monitor
    {{ range .Values.targets }}

    [[inputs.snmp]]
      # Enumerate agent addresses to retrieve values from.
      agents = [{{- range $value := .hostGroup.hosts }}
      "udp://{{ $value }}",
      {{ end -}}]

      timeout = "5s"
      version = 2
      community = {{ .hostGroup.community | quote }}
      retries = 3
      max_repetitions = 10

      # SNMP oids to poll
      {{ .hostGroup.oids | indent 4 }}

    {{ end }}
